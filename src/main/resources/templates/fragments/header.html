<div th:fragment="header"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
     th:with="lang=${lang != null ? lang : 'en'}">

    <!-- üî• GLASS HEADER WRAPPER -->
    <header id="mainHeader" class="site-header">
        <!-- ================= TOP NAV ================= -->
        <nav class="navbar navbar-light bg-white border-bottom px-4 header-grid">

            <!-- LEFT : LOGO -->
            <div class="nav-left">
                <a class="navbar-brand fw-bold"
                   th:href="@{/{lang}(lang=${lang})}">
                    TQtadka
                </a>
            </div>

            <!-- CENTER : SEARCH -->
            <div class="nav-center">
                <form th:action="@{/{lang}/search(lang=${lang})}"
                      method="get"
                      class="header-search d-flex align-items-center">

                    <input type="search"
                           name="q"
                           class="form-control form-control-sm rounded-pill search-input"
                           placeholder="Search #tags, topics, ideas..."
                           aria-label="Search"
                           required>

                    <button type="submit"
                            class="search-btn ms-2"
                            aria-label="Search">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>

            <!-- RIGHT : LANG + AUTH -->
            <div class="nav-right d-flex align-items-center gap-3">

                <!-- LANGUAGE TOGGLE -->
                <div class="btn-group btn-group-sm">
                    <a th:href="@{/en}"
                       class="btn btn-outline-dark"
                       th:classappend="${lang == 'en'} ? ' active' : ''">
                        EN
                    </a>

                    <a th:href="@{/kn}"
                       class="btn btn-outline-dark"
                       th:classappend="${lang == 'kn'} ? ' active' : ''">
                        ‡≤ï‡≤®‡≥ç‡≤®‡≤°
                    </a>
                </div>

                <!-- LOGGED IN -->
                <div sec:authorize="isAuthenticated()"
                     class="d-flex align-items-center gap-3">

                    <a sec:authorize="hasRole('ADMIN')"
                       th:href="@{/admin}"
                       class="fw-semibold text-decoration-none text-dark">
                        Admin
                    </a>

                    <a sec:authorize="hasRole('AUTHOR')"
                       th:href="@{/admin}"
                       class="fw-semibold text-decoration-none text-dark">
                        Author
                    </a>

                    <span sec:authorize="!hasAnyRole('ADMIN','AUTHOR')"
                          class="text-muted small">
                Hi, <strong sec:authentication="name"></strong>
            </span>

                    <form th:action="@{/logout}" method="post" class="mb-0">
                        <input type="hidden"
                               th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}" />
                        <button class="btn btn-outline-danger btn-sm">
                            Logout
                        </button>
                    </form>
                </div>
            </div>
        </nav>

        <!-- ================= CATEGORY BAR ================= -->
        <nav id="categoryNav" class="category-nav">
        <div class="border-bottom px-4 py-2"
             th:if="${categories != null and !#lists.isEmpty(categories)}">

            <div class="d-flex gap-4 flex-wrap">
                <a th:each="cat : ${categories}"
                   th:href="@{/{lang}/category/{cat}(lang=${lang}, cat=${cat})}"
                   th:text="${cat}"
                   th:classappend="${activeCategory != null and cat == activeCategory} ? ' active' : ''"
                   class="category-link text-decoration-none">
                </a>
            </div>

        </div>
        </nav>
    </header>

    <script>
        const header = document.getElementById("mainHeader");

        window.addEventListener("scroll", () => {
            if (window.scrollY > 20) {
                header.classList.add("scrolled");
            } else {
                header.classList.remove("scrolled");
            }
        });
    </script>

    <script>
        const categoryNav = document.getElementById("categoryNav");

        window.addEventListener("scroll", () => {
            if (!categoryNav) return;

            // mobile only
            if (window.innerWidth <= 768) {
                if (window.scrollY > 80) {
                    // once scrolled, ALWAYS hide
                    categoryNav.classList.add("hide");
                } else {
                    // only show when at top
                    categoryNav.classList.remove("hide");
                }
            }
        });
    </script>

</div>