<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Admin Â· Posts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

<!-- ================= HEADER ================= -->
<th:block
        th:with="
            lang=${lang != null ? lang : 'en'},
            categories=${categories != null ? categories : {}},
            activeCategory=${activeCategory != null ? activeCategory : null}
        ">
    <header th:replace="~{fragments/header :: header}"></header>
</th:block>

<!-- ================= ADMIN LAYOUT ================= -->
<div class="d-flex">

    <!-- SIDEBAR -->
    <aside sec:authorize="hasAnyRole('ADMIN','AUTHOR')">
        <div th:replace="~{fragments/admin-sidebar :: adminSidebar}"></div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-grow-1 p-4 bg-light">

        <!-- PAGE HEADER -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold mb-0">Manage Posts</h2>

            <a th:href="@{/admin/posts/create}"
               class="btn btn-dark">
                + Create Post
            </a>
        </div>

        <!-- EMPTY STATE -->
        <div th:if="${posts == null or #lists.isEmpty(posts)}"
             class="alert alert-secondary">
            No posts created yet.
        </div>

        <!-- POSTS TABLE -->
        <table th:if="${posts != null and !#lists.isEmpty(posts)}"
               class="table table-bordered table-hover align-middle bg-white">

            <thead class="table-light">
            <tr>
                <th>Title</th>
                <th>Lang</th>
                <th>Category</th>
                <th>Status</th>
                <th>Views</th>
                <th style="width:220px;">Actions</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="post : ${posts}">

                <td class="fw-semibold" th:text="${post.title}"></td>

                <td>
                    <span class="badge bg-info text-dark"
                          th:text="${post.language.name()}"></span>
                </td>

                <td>
                    <span class="badge bg-secondary"
                          th:text="${post.category.name()}"></span>
                </td>

                <td>
                    <form method="post"
                          th:action="@{/admin/posts/toggle-status}"
                          class="d-inline">

                        <input type="hidden"
                               th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}"/>

                        <input type="hidden" name="slug" th:value="${post.slug}"/>
                        <input type="hidden" name="language" th:value="${post.language.name()}"/>

                        <select name="publish"
                                class="form-select form-select-sm"
                                onchange="this.form.submit()">
                            <option value="true" th:selected="${post.published}">Published</option>
                            <option value="false" th:selected="${!post.published}">Draft</option>
                        </select>
                    </form>
                </td>

                <td th:text="${post.views}"></td>

                <td class="text-nowrap">
                    <a th:href="@{/admin/posts/edit/{slug}/{language}(
                            slug=${post.slug},
                            language=${post.language.name()})}"
                       class="btn btn-sm btn-outline-primary me-1">
                        Edit
                    </a>

                    <form method="post"
                          th:action="@{/admin/posts/delete}"
                          class="d-inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="slug" th:value="${post.slug}"/>
                        <input type="hidden" name="language" th:value="${post.language.name()}"/>

                        <button type="submit"
                                class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Delete this post?')">
                            Delete
                        </button>
                    </form>
                </td>

            </tr>
            </tbody>
        </table>

    </main>

</div>

<!-- ================= FOOTER ================= -->
<footer th:replace="~{fragments/footer :: footer}"></footer>

</body>
</html>