<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Edit Blog Post</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- Quill -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css"
          rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body class="bg-light">

<!-- HEADER -->
<header th:replace="~{fragments/header :: header}"></header>

<div class="d-flex">

    <!-- SIDEBAR -->
    <aside sec:authorize="hasAnyRole('ADMIN','AUTHOR')">
        <div th:replace="~{fragments/admin-sidebar :: adminSidebar}"></div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-grow-1 p-4">

        <div class="container" style="max-width:760px;">

            <h3 class="fw-bold mb-4">Edit Blog Post</h3>

            <form method="post"
                  th:action="@{/admin/posts/update}"
                  id="editForm">

                <!-- CSRF -->
                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}"/>

                <!-- ðŸ”¥ REQUIRED IDS -->
                <input type="hidden" name="postId" th:value="${post.id}">
                <input type="hidden" name="language" th:value="${post.language.name()}">

                <!-- TITLE -->
                <input class="form-control mb-3"
                       name="title"
                       th:value="${post.title}"
                       required>

                <!-- CATEGORY -->
                <select class="form-select mb-3" name="category" required>
                    <option th:each="c : ${categories}"
                            th:value="${c}"
                            th:text="${c}"
                            th:selected="${c == post.category}">
                    </option>
                </select>

                <!-- IMAGE -->
                <input class="form-control mb-3"
                       name="imageUrl"
                       th:value="${post.imageUrl}"
                       placeholder="Main image URL">

                <!-- INTRO -->
                <textarea class="form-control mb-4"
                          name="intro"
                          rows="4"
                          th:text="${post.intro}">
                </textarea>

                <!-- CONTENT -->
                <h6 class="fw-bold mb-2">Post Content</h6>
                <div id="editor" class="bg-white mb-3 border rounded" style="height:300px;"></div>

                <input type="hidden" name="sectionContent" id="sectionContent">

                <!-- SECTION -->
                <th:block th:with="section=${post.sections[0]}">
                    <input type="hidden" id="existingContent" th:value="${section.content}"/>

                    <input class="form-control mb-2"
                           name="bulletTitle"
                           th:value="${section.bulletTitle}"
                           placeholder="Bullet title">

                    <textarea class="form-control mb-4"
                              name="bullets"
                              rows="4"
                              th:text="${section.bullets}">
                    </textarea>

                    <input class="form-control mb-2"
                           name="tipTitle"
                           th:value="${section.tipTitle}"
                           placeholder="Tip title">

                    <textarea class="form-control mb-4"
                              name="tipContent"
                              rows="3"
                              th:text="${section.tipContent}">
                    </textarea>
                </th:block>

                <!-- PUBLISH -->
                <input type="hidden" name="publish" value="false">

                <div class="form-check mb-4">
                    <input class="form-check-input"
                           type="checkbox"
                           name="publish"
                           value="true"
                           th:checked="${post.published}">
                    <label class="form-check-label">Published</label>
                </div>

                <!-- ACTIONS -->
                <button type="submit" class="btn btn-dark">
                    Update Post
                </button>

                <a th:href="@{/admin/posts}" class="btn btn-outline-secondary ms-2">
                    Cancel
                </a>
            </form>
        </div>

    </main>
</div>

<!-- QUILL -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link'],
                ['clean']
            ]
        }
    });

    const existing = document.getElementById('existingContent').value;
    if (existing) quill.root.innerHTML = existing;

    document.getElementById('editForm').addEventListener('submit', function () {
        document.getElementById('sectionContent').value =
                quill.root.innerHTML.trim();
    });
</script>

</body>
</html>