<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Edit Blog Post</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css"
          rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/style.css}">

    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body class="bg-light">

<header th:replace="~{fragments/header :: header}"></header>

<div class="page-content d-flex">

    <aside sec:authorize="hasAnyRole('ADMIN','AUTHOR')">
        <div th:replace="~{fragments/admin-sidebar :: adminSidebar}"></div>
    </aside>

    <main class="flex-grow-1 p-4">

        <div class="container" style="max-width:760px;">

            <br>
            <br>
            <br>
            <br>
            <br>

            <h3 class="fw-bold mb-4">Edit Blog Post</h3>

            <form method="post"
                  th:action="@{/admin/posts/update/{id}(id=${post.id})}"
                  id="editForm">

                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}"/>

                <input type="hidden" name="postId" th:value="${post.id}">
                <input type="hidden" name="language" th:value="${post.language.name()}">

                <!-- TITLE -->
                <input class="form-control mb-3"
                       name="title"
                       th:value="${post.title}"
                       required>

                <!-- CATEGORY -->
                <select class="form-select mb-3"
                        name="category"
                        id="categorySelect"
                        required>
                    <option th:each="c : ${categories}"
                            th:value="${c}"
                            th:text="${c}"
                            th:selected="${c == post.category}">
                    </option>
                </select>

                <!-- ‚úÖ AI MODE -->
                <div id="aiModeBox"
                     class="mb-4"
                     th:if="${post.category.name() == 'AI'}">

                    <label class="form-label fw-semibold">AI Post Type</label>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="radio"
                               name="aiPostMode"
                               value="BLOG"
                               th:checked="${post.aiPostMode.name() == 'BLOG'}">
                        <label class="form-check-label">AI Blog / App / News</label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="radio"
                               name="aiPostMode"
                               value="PROMPT"
                               th:checked="${post.aiPostMode.name() == 'PROMPT'}">
                        <label class="form-check-label">AI Prompt</label>
                    </div>
                </div>

                <!-- ======================
                     MAIN IMAGE (EDIT)
                ====================== -->
                <label class="form-label fw-semibold">
                    Main Image <span class="text-danger">*</span>
                </label>


                <input type="file"
                       class="form-control mb-2"
                       id="imageFile"
                       accept="image/*">

                <img id="imagePreview"
                     th:src="${post.imageUrl}"
                     class="mb-2"
                     style="max-height:200px; border-radius:8px;
            display: [[${post.imageUrl != null}]] ? 'block' : 'none';"/>

                <input type="hidden"
                       name="imageUrl"
                       id="imageUrl"
                       th:value="${post.imageUrl}"/>

                <input type="hidden"
                       name="existingImageUrl"
                       th:value="${post.imageUrl}"/>

                <div class="form-check mb-3">
                    <input class="form-check-input"
                           type="checkbox"
                           name="removeImage"
                           value="true"
                           id="removeImageCheck">
                    <label class="form-check-label" for="removeImageCheck">
                        Remove main image
                    </label>
                </div>

                <!-- INTRO -->
                <textarea class="form-control mb-4"
                          name="intro"
                          rows="4"
                          th:text="${post.intro}">
                </textarea>

                <!-- TAGS -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        Tags <span class="text-muted small">(comma separated)</span>
                    </label>

                    <input type="text"
                           class="form-control"
                           name="tags"
                           placeholder="AI, Java, Backend"
                           th:value="${tagString}">
                </div>



                <!-- ===============================
     IMAGE SECTIONS (EDIT)
================================ -->
                <div class="mb-5">

                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="fw-bold mb-0">Image Sections</h6>

                        <button type="button"
                                class="btn btn-outline-dark btn-sm"
                                onclick="addImageSection()">
                            ‚ûï Add Section
                        </button>
                    </div>

                    <div id="imageSectionContainer"
                         class="d-flex flex-column gap-3">
                    </div>
                </div>

                <input type="hidden"
                       name="imageSectionsJson"
                       id="imageSectionsJson">

                <!-- üî• EXISTING IMAGE SECTIONS (SAFE) -->
                <script th:inline="javascript">
                    /*<![CDATA[*/
                        const existingImageSections =
                            /*[[${imageSectionDtos}]]*/ [];
                    /*]]>*/
                </script>

                <!-- CONTENT -->
                <h6 class="fw-bold mb-2">Post Content</h6>
                <div id="editor"
                     class="bg-white mb-3 border rounded"
                     style="height:300px;"></div>

                <input type="hidden" name="sectionContent" id="sectionContent">

                <!-- SECTION -->
                <th:block th:with="section=${post.sections[0]}">
                    <input type="hidden" id="existingContent"
                           th:value="${section.content}"/>

                    <input class="form-control mb-2"
                           name="bulletTitle"
                           th:value="${section.bulletTitle}"
                           placeholder="Bullet title">

                    <textarea class="form-control mb-4"
                              name="bullets"
                              rows="4"
                              th:text="${section.bullets}">
                    </textarea>

                    <input class="form-control mb-2"
                           name="tipTitle"
                           th:value="${section.tipTitle}"
                           placeholder="Tip title">

                    <textarea class="form-control mb-4"
                              name="tipContent"
                              rows="3"
                              th:text="${section.tipContent}">
                    </textarea>
                </th:block>

                <div id="promptSection"
                     class="mt-4"
                     style="display:none"
                     th:if="${post.category.name() == 'AI'}">

                    <h6 class="fw-bold mb-2">AI Prompts</h6>

                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th style="width:25%">Prompt Name</th>
                            <th>Prompt Text</th>
                            <th style="width:50px"></th>
                        </tr>
                        </thead>

                        <tbody id="promptTableBody">
                        <tr th:each="p : ${post.aiPrompts}">
                            <td>
                                <input class="form-control"
                                       name="promptNames"
                                       th:value="${p.name}">
                            </td>
                            <td>
                <textarea class="form-control"
                          rows="3"
                          name="promptTexts"
                          th:text="${p.promptText}">
                </textarea>
                            </td>
                            <td class="text-center">
                                <button type="button"
                                        class="btn btn-sm btn-danger"
                                        onclick="this.closest('tr').remove()">‚úï</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <button type="button"
                            class="btn btn-sm btn-outline-dark"
                            onclick="addPromptRow()">
                        + Add Prompt
                    </button>
                </div>

                <!-- =========================
     RELATED BLOGS (EDIT)
========================= -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        üîó Related Blogs
                    </label>

                    <div id="relatedBlogsContainer">

                        <!-- Prefill existing related slugs -->
                        <div class="input-group mb-2"
                             th:each="slug : ${post.relatedPostSlugs}">
                            <input
                                    type="text"
                                    name="relatedSlugs"
                                    class="form-control"
                                    th:value="${slug}"
                                    placeholder="Paste blog URL or slug"/>

                            <button
                                    type="button"
                                    class="btn btn-outline-danger"
                                    onclick="removeRelatedBlog(this)">
                                ‚úï
                            </button>
                        </div>

                        <!-- If no related blogs exist -->
                        <div class="input-group mb-2"
                             th:if="${#lists.isEmpty(post.relatedPostSlugs)}">
                            <input
                                    type="text"
                                    name="relatedSlugs"
                                    class="form-control"
                                    placeholder="Paste blog URL or slug"/>
                            <button
                                    type="button"
                                    class="btn btn-outline-danger"
                                    onclick="removeRelatedBlog(this)">
                                ‚úï
                            </button>
                        </div>

                    </div>

                    <button
                            type="button"
                            class="btn btn-sm btn-outline-primary mt-2"
                            onclick="addRelatedBlog()">
                        ‚ûï Add Related Blog
                    </button>

                    <small class="text-muted d-block mt-2">
                        ‚Ä¢ One blog per input<br>
                        ‚Ä¢ You can paste full URLs or just the slug<br>
                        ‚Ä¢ These posts will appear as ‚ÄúRelated Blogs‚Äù on the blog page
                    </small>
                </div>

                <!-- PUBLISH -->
                <input type="hidden" name="publish" value="false">

                <div class="form-check mb-4">
                    <input class="form-check-input"
                           type="checkbox"
                           name="publish"
                           value="true"
                           th:checked="${post.published}">
                    <label class="form-check-label">Published</label>
                </div>

                <button type="submit" class="btn btn-dark">
                    Update Post
                </button>

                <a th:href="@{/admin/posts}" class="btn btn-outline-secondary ms-2">
                    Cancel
                </a>
            </form>
        </div>

    </main>
</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
    document.getElementById("editForm")
    .addEventListener("submit", function (e) {

    // üîí Block submit during upload
    if (uploadInProgress) {
        alert("Please wait for image upload to finish");
        e.preventDefault();
        return;
    }

    // üî• HERO IMAGE MANDATORY
    const heroImageUrl =
        document.getElementById("imageUrl").value.trim();

    if (!heroImageUrl) {
        alert("Hero image is mandatory");
        e.preventDefault();
        return;
    }

    // ‚úçÔ∏è Validate Quill content
    const html = quill.root.innerHTML.trim();

    if (!html || html === "<p><br></p>") {
        alert("Post content cannot be empty");
        e.preventDefault();
        return;
    }

    document.getElementById("sectionContent").value = html;

    // üñº Serialize image sections
    const sections = [];

    document
        .querySelectorAll("#imageSectionContainer .card")
        .forEach((card, i) => {

            const imageUrl =
                card.querySelector('[data-field="imageUrl"]').value.trim();

            const heading =
                card.querySelector('[data-field="heading"]').value.trim();

            const description =
                card.querySelector('[data-field="description"]').value.trim();

            if (imageUrl || heading || description) {
                sections.push({
                    order: i + 1,
                    imageUrl,
                    heading,
                    description
                });
            }
        });

    document.getElementById("imageSectionsJson").value =
        JSON.stringify(sections);
});
</script>

<script>
    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link'],
                ['clean']
            ]
        }
    });

    const existing = document.getElementById('existingContent').value;
    if (existing) quill.root.innerHTML = existing;

    document.getElementById('editForm').addEventListener('submit', function () {
        document.getElementById('sectionContent').value =
                quill.root.innerHTML.trim();
    });

    function addPromptRow() {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input class="form-control" name="promptNames">
            </td>
            <td>
                <textarea class="form-control" name="promptTexts" rows="3"></textarea>
            </td>
            <td class="text-center">
                <button type="button"
                        class="btn btn-sm btn-danger"
                        onclick="this.closest('tr').remove()">‚úï</button>
            </td>
        `;
        document.getElementById('promptTableBody').appendChild(row);
    }


        const promptSection = document.getElementById('promptSection');
    const aiModeRadios = document.querySelectorAll('input[name="aiPostMode"]');

    function togglePromptSection() {
        const selected = document.querySelector('input[name="aiPostMode"]:checked');
        if (selected && selected.value === 'PROMPT') {
            promptSection.style.display = 'block';
        } else {
            promptSection.style.display = 'none';
        }
    }

    aiModeRadios.forEach(radio => {
        radio.addEventListener('change', togglePromptSection);
    });

    // initial load
    togglePromptSection();

let imageSectionIndex = 0;

function addImageSection(imageUrl = '', heading = '', description = '') {

    const container = document.getElementById("imageSectionContainer");
    const index = container.querySelectorAll(".card").length;

    const wrapper = document.createElement("div");
    wrapper.className = "card p-3";

    wrapper.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Section ${index + 1}</strong>
            <button type="button"
                    class="btn btn-sm btn-danger"
                    onclick="this.closest('.card').remove()">‚úï</button>
        </div>

        <input type="file"
               class="form-control mb-2 section-image-file"
               accept="image/*">

        <img class="section-image-preview mb-2"
             style="display:${imageUrl ? 'block' : 'none'}; max-height:150px; border-radius:6px;"
             src="${imageUrl}"/>

        <input type="hidden"
               class="section-image-url"
               data-field="imageUrl"
               value="${imageUrl}">

        <button type="button"
                class="btn btn-sm btn-outline-danger mb-2 remove-section-image"
                style="display:${imageUrl ? 'inline-block' : 'none'};">
            Remove image
        </button>

        <input class="form-control mb-2"
               placeholder="Section heading"
               data-field="heading"
               value="${heading}">

        <textarea class="form-control"
                  rows="3"
                  placeholder="Section description"
                  data-field="description">${description}</textarea>
    `;

    container.appendChild(wrapper);
    wireSectionImageUpload(wrapper);
}

/* ===============================
   üî• HYDRATE ON PAGE LOAD
================================ */
document.addEventListener("DOMContentLoaded", function () {
    if (Array.isArray(existingImageSections)) {
        existingImageSections.forEach(s => {
            addImageSection(
                s.imageUrl || '',
                s.heading || '',
                s.description || ''
            );
        });
    }
});

/* ===============================
   SERIALIZE ON SUBMIT (UNCHANGED)
================================ */
document.getElementById("editForm")
    .addEventListener("submit", function () {

        const sections = [];

        document
            .querySelectorAll("#imageSectionContainer .card")
            .forEach((card, i) => {

                const imageUrl =
                    card.querySelector('[data-field="imageUrl"]').value.trim();
                const heading =
                    card.querySelector('[data-field="heading"]').value.trim();
                const description =
                    card.querySelector('[data-field="description"]').value.trim();

                if (imageUrl || heading || description) {
                    sections.push({
                        order: i + 1,
                        imageUrl,
                        heading,
                        description
                    });
                }
            });

        document.getElementById("imageSectionsJson").value =
            JSON.stringify(sections);
    });

</script>

<script>
    function addRelatedBlog() {
        const container = document.getElementById("relatedBlogsContainer");

        const div = document.createElement("div");
        div.className = "input-group mb-2";

        div.innerHTML = `
            <input
                type="text"
                name="relatedSlugs"
                class="form-control"
                placeholder="Paste blog URL or slug"/>
            <button
                type="button"
                class="btn btn-outline-danger"
                onclick="removeRelatedBlog(this)">
                ‚úï
            </button>
        `;

        container.appendChild(div);
    }

    function removeRelatedBlog(button) {
        button.closest(".input-group").remove();
    }
</script>
<script>
    let uploadInProgress = false;
    const submitBtn = document.querySelector("button[type='submit']");
    const imageInput = document.getElementById("imageFile");
    const preview = document.getElementById("imagePreview");
    const imageUrlInput = document.getElementById("imageUrl");
    const removeCheck = document.getElementById("removeImageCheck");

    /* =========================
       IMAGE UPLOAD
    ========================= */
    imageInput.addEventListener("change", async function () {

        const file = this.files[0];
        if (!file) return;

        uploadInProgress = true;
        submitBtn.disabled = true;

        // ‚úÖ show preview instantly
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";

       const csrfToken =
    document.querySelector('meta[name="_csrf"]').content;
const csrfHeader =
    document.querySelector('meta[name="_csrf_header"]').content;

        const formData = new FormData();
        formData.append("file", file);

        try {
            const res = await fetch("/admin/images/upload", {
                method: "POST",
                headers: { [csrfHeader]: csrfToken },
                body: formData
            });

            if (!res.ok) throw new Error("Upload failed");

            const data = await res.json();

            // ‚úÖ restore imageUrl
            imageUrlInput.value = data.url;

            // ‚úÖ cancel removal state
            removeCheck.checked = false;

        } catch (e) {
            alert("Image upload failed");
            preview.src = "";
            preview.style.display = "none";
        } finally {
            uploadInProgress = false;
            submitBtn.disabled = false;
        }
    });

    /* =========================
       REMOVE IMAGE
    ========================= */
    removeCheck.addEventListener("change", function () {

        if (this.checked) {
            imageUrlInput.value = "";

            // ‚úÖ fully reset preview
            preview.src = "";
            preview.style.display = "none";

            // ‚úÖ allow re-selecting SAME file again
            imageInput.value = "";
        }
    });

    function wireSectionImageUpload(card) {

    const fileInput = card.querySelector(".section-image-file");
    const preview = card.querySelector(".section-image-preview");
    const imageUrlInput = card.querySelector(".section-image-url");
    const removeBtn = card.querySelector(".remove-section-image");

    fileInput.addEventListener("change", async function () {

        const file = this.files[0];
        if (!file) return;

        uploadInProgress = true;
        submitBtn.disabled = true;

        const csrfToken =
            document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader =
            document.querySelector('meta[name="_csrf_header"]').content;

        const formData = new FormData();
        formData.append("file", file);

        try {
            const res = await fetch("/admin/images/upload", {
                method: "POST",
                headers: { [csrfHeader]: csrfToken },
                body: formData
            });

            if (!res.ok) throw new Error("Upload failed");

            const data = await res.json();

            imageUrlInput.value = data.url;
            preview.src = data.url;
            preview.style.display = "block";
            removeBtn.style.display = "inline-block";

        } catch (e) {
            alert("Section image upload failed");
        } finally {
            uploadInProgress = false;
            submitBtn.disabled = false;
        }
    });

    removeBtn.addEventListener("click", () => {
        fileInput.value = "";
        imageUrlInput.value = "";
        preview.src = "";
        preview.style.display = "none";
        removeBtn.style.display = "none";
    });
}
</script>

<!-- ================= FOOTER ================= -->
<footer th:replace="~{fragments/footer :: footer}"></footer>

</body>
</html>