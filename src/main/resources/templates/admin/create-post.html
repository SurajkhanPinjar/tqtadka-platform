<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Create Blog Post</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap"
          rel="stylesheet">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- Quill -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/style.css}">

    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body class="bg-light">

<header th:replace="~{fragments/header :: header}"></header>

<div class="page-content d-flex">

    <aside class="flex-shrink-0"
           sec:authorize="hasAnyRole('ADMIN','AUTHOR')">
        <div th:replace="~{fragments/admin-sidebar :: adminSidebar}"></div>
    </aside>

    <main class="flex-grow-1 p-4">
        <br>
        <br>
        <br>
        <br>
        <br>
        <div class="mx-auto" style="max-width:760px;">

            <h3 class="fw-bold mb-4">Create Blog Post</h3>

            <form method="post"
                  th:action="@{/admin/posts/create}"
                  id="postForm">

                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}"/>

                <!-- TITLE -->
                <input class="form-control mb-3"
                       name="title"
                       placeholder="Post title"
                       required>

                <!-- LANGUAGE -->
                <select class="form-select mb-3" name="language" required>
                    <option value="">Select Language</option>
                    <option value="EN">English</option>
                    <option value="KN">Kannada</option>
                </select>

                <!-- CATEGORY -->
                <select class="form-select mb-3"
                        name="category"
                        id="categorySelect"
                        required>
                    <option value="">Select Category</option>
                    <option th:each="cat : ${categories}"
                            th:value="${cat}"
                            th:text="${cat}">
                    </option>
                </select>

                <!-- ‚úÖ AI MODE (ONLY FOR AI CATEGORY) -->
                <div id="aiModeBox" class="mb-4" style="display:none;">
                    <label class="form-label fw-semibold">AI Post Type</label>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="radio"
                               name="aiPostMode"
                               value="BLOG"
                               checked>
                        <label class="form-check-label">
                            AI Blog / App / News
                        </label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="radio"
                               name="aiPostMode"
                               value="PROMPT">
                        <label class="form-check-label">
                            AI Prompt
                        </label>
                    </div>
                </div>

                <!-- IMAGE UPLOAD -->
                <label class="form-label fw-semibold">
                    Main Image <span class="text-danger">*</span>
                </label>

                <input type="file"
                       class="form-control mb-2"
                       id="imageFile"
                       accept="image/*">

                <!-- Preview -->
                <img id="imagePreview"
                     style="display:none; max-height:200px; border-radius:8px;"
                     class="mb-3"/>

                <button type="button"
                        id="removeImageBtn"
                        class="btn btn-sm btn-outline-danger mb-3"
                        style="display:none;">
                    Remove image
                </button>

                <!-- Hidden field (IMPORTANT) -->
                <input type="hidden"
                       name="imageUrl"
                       id="imageUrl">

                <!-- INTRO -->
                <textarea class="form-control mb-4"
                          name="intro"
                          rows="4"
                          placeholder="Short intro paragraph"></textarea>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Tags</label>

                    <input type="text"
                           name="tags"
                           class="form-control"
                           placeholder="AI, Java, Backend, Spring Boot"
                           help="Comma separated" />

                    <small class="text-muted">
                        Use commas. Example: AI, Finance, Productivity
                    </small>
                </div>

                <!-- ===============================
                     IMAGE SECTIONS
                ================================ -->
                <div class="mb-5">

                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="fw-bold mb-0">Image Sections</h6>

                        <button type="button"
                                class="btn btn-outline-dark btn-sm"
                                onclick="addImageSection()">
                            ‚ûï Add Section
                        </button>
                    </div>

                    <div id="imageSectionContainer"
                         class="d-flex flex-column gap-3">
                    </div>
                </div>

                <!-- CONTENT -->
                <h6 class="fw-bold mb-2">Post Content</h6>
                <div id="editor"
                     class="bg-white mb-3 border"
                     style="height:300px;"></div>

                <input type="hidden" name="sectionContent" id="sectionContent">

                <!-- ‚úÖ AI PROMPT TABLE -->
                <div id="promptBox" style="display:none;">
                    <h6 class="fw-bold mt-4">AI Prompts</h6>

                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th style="width:200px">Prompt Name</th>
                            <th>Prompt Text</th>
                            <th style="width:60px"></th>
                        </tr>
                        </thead>
                        <tbody id="promptTableBody"></tbody>
                    </table>

                    <button type="button"
                            class="btn btn-outline-dark btn-sm"
                            onclick="addPromptRow()">
                        ‚ûï Add Prompt
                    </button>
                </div>

                <!-- BULLETS -->
                <input class="form-control mb-2"
                       name="bulletTitle"
                       placeholder="Bullet section heading (optional)">

                <textarea class="form-control mb-4"
                          name="bullets"
                          rows="4"
                          placeholder="One bullet per line"></textarea>

                <!-- TIP -->
                <input class="form-control mb-2"
                       name="tipTitle"
                       placeholder="Tip title (optional)">

                <textarea class="form-control mb-4"
                          name="tipContent"
                          rows="3"
                          placeholder="Tip explanation"></textarea>

                <div class="mt-4">
                    <label class="fw-bold mb-2">üîó Related Blogs</label>

                    <div id="relatedBlogsContainer">

                        <!-- Existing values (EDIT MODE only) -->
                        <div th:if="${post != null and post.relatedPostSlugs != null}"
                             th:each="slug : ${post.relatedPostSlugs}"
                             class="input-group mb-2">

                            <input
                                    type="text"
                                    name="relatedSlugs"
                                    class="form-control"
                                    th:value="${slug}"
                                    placeholder="Paste blog URL or slug"/>

                            <button
                                    type="button"
                                    class="btn btn-outline-danger"
                                    onclick="removeRelatedBlog(this)">
                                ‚úï
                            </button>
                        </div>

                    </div>

                    <button
                            type="button"
                            class="btn btn-sm btn-outline-primary mt-2"
                            onclick="addRelatedBlog()">
                        ‚ûï Add Related Blog
                    </button>

                    <small class="text-muted d-block mt-2">
                        One blog per input ¬∑ You can paste full URL or just the slug
                    </small>
                </div>

                <!-- PUBLISH -->
                <input type="hidden" name="publish" value="false">

                <input type="hidden"
                       name="imageSectionsJson"
                       id="imageSectionsJson">

                <div class="form-check mb-4">
                    <input class="form-check-input"
                           type="checkbox"
                           id="publish"
                           name="publish"
                           value="true"
                           checked>
                    <label class="form-check-label" for="publish">
                        Publish immediately
                    </label>
                </div>

                <button type="submit"
                        id="publishBtn"
                        class="btn btn-dark px-4">
                    Publish
                </button>

            </form>
        </div>

    </main>
</div>

<!-- QUILL -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
    const MAX_IMAGE_SIZE = 400 * 1024; // 400 KB
</script>

<script>
    let uploadInProgress = false;

    document.getElementById('postForm').addEventListener('submit', function (e) {

    // üîí Block submit during image upload
    if (uploadInProgress) {
        alert("Please wait for image upload to finish");
        e.preventDefault();
        return;
    }

    // üî• HERO IMAGE MANDATORY CHECK
    const heroImageUrl = document.getElementById("imageUrl").value.trim();

    if (!heroImageUrl) {
        alert("Hero image is mandatory");
        e.preventDefault();
        return;
    }

    // ‚úçÔ∏è Validate editor content
    const html = quill.root.innerHTML.trim();
    if (!html || html === '<p><br></p>') {
        alert('Post content cannot be empty');
        e.preventDefault();
        return;
    }

    document.getElementById('sectionContent').value = html;
});
</script>

<script>
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Write your blog content here...',
        modules: {
            toolbar: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link'],
                ['clean']
            ]
        }
    });

document.getElementById('postForm').addEventListener('submit', function (e) {

    // üîí Block submit during image upload
    if (uploadInProgress) {
        alert("Please wait for image upload to finish");
        e.preventDefault();
        return;
    }

    // ‚úçÔ∏è Validate editor content
    const html = quill.root.innerHTML.trim();
    if (!html || html === '<p><br></p>') {
        alert('Post content cannot be empty');
        e.preventDefault();
        return;
    }
    document.getElementById('sectionContent').value = html;

    // üñº Serialize image sections
    const sections = [];

    document
        .querySelectorAll("#imageSectionContainer .card")
        .forEach((card, i) => {

            const imageUrl = card.querySelector('[data-field="imageUrl"]').value.trim();
            const heading = card.querySelector('[data-field="heading"]').value.trim();
            const description = card.querySelector('[data-field="description"]').value.trim();

            if (heading || description) {
                if (!imageUrl) {
                    alert("Section image missing");
                    e.preventDefault();
                    return;
                }

                sections.push({
                    order: i + 1,
                    imageUrl,
                    heading,
                    description
                });
            }
        });

    document.getElementById("imageSectionsJson").value =
        JSON.stringify(sections);
});

    /* =========================
       üî• AI PROMPT LOGIC (SAFE)
    ========================= */
    const categorySelect = document.getElementById('categorySelect');
    const aiModeBox = document.getElementById('aiModeBox');
    const promptBox = document.getElementById('promptBox');

    function handleCategoryChange() {
        if (categorySelect.value === 'AI') {
            aiModeBox.style.display = 'block';
        } else {
            aiModeBox.style.display = 'none';
            promptBox.style.display = 'none';
        }
    }

    categorySelect.addEventListener('change', handleCategoryChange);
    handleCategoryChange();

    document.querySelectorAll('[name="aiPostMode"]').forEach(radio => {
        radio.addEventListener('change', () => {
            promptBox.style.display =
                radio.value === 'PROMPT' && radio.checked
                    ? 'block'
                    : 'none';
        });
    });

function addPromptRow() {
    const tbody = document.getElementById('promptTableBody');

    const tr = document.createElement('tr');

    // Prompt Name
    const nameTd = document.createElement('td');
    const nameInput = document.createElement('input');
    nameInput.className = 'form-control';
    nameInput.name = 'promptNames';
    nameInput.placeholder = 'Prompt name';
    nameInput.required = true;
    nameTd.appendChild(nameInput);

    // Prompt Text
    const textTd = document.createElement('td');
    const textarea = document.createElement('textarea');
    textarea.className = 'form-control ai-prompt-textarea';
    textarea.name = 'promptTexts';
    textarea.rows = 4;
    textarea.placeholder = 'Enter AI prompt (max 1000 characters)';
    textarea.maxLength = 1000;
    textarea.spellcheck = false;
    textarea.wrap = 'soft';
    textTd.appendChild(textarea);

    // Remove Button
    const actionTd = document.createElement('td');
    actionTd.className = 'text-center';
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-sm btn-danger';
    btn.innerText = '‚úï';
    btn.onclick = () => tr.remove();
    actionTd.appendChild(btn);

    tr.appendChild(nameTd);
    tr.appendChild(textTd);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
}

        function handlePromptKeydown(e, textarea) {
        const max = parseInt(textarea.dataset.maxChars || '1000');
        const allowedKeys = [
            'Backspace', 'Delete',
            'ArrowLeft', 'ArrowRight',
            'ArrowUp', 'ArrowDown',
            'Control', 'Meta'
        ];

        if (allowedKeys.includes(e.key) || e.ctrlKey || e.metaKey) {
            return;
        }

        if (textarea.value.length >= max) {
            e.preventDefault();
        }
    }

    function updateCharCount(textarea) {
        const counter =
            textarea.parentElement.querySelector('.char-count');

        if (counter) {
            counter.innerText = textarea.value.length;
        }

        // auto-grow height
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    // Init counters if rows already exist
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.ai-prompt-textarea')
            .forEach(t => updateCharCount(t));
    });


</script>
<script>
    function addRelatedBlog() {
        const container = document.getElementById("relatedBlogsContainer");

        const wrapper = document.createElement("div");
        wrapper.className = "input-group mb-2";

        wrapper.innerHTML = `
            <input
                type="text"
                name="relatedSlugs"
                class="form-control"
                placeholder="Paste blog URL or slug"/>

            <button
                type="button"
                class="btn btn-outline-danger"
                onclick="removeRelatedBlog(this)">
                ‚úï
            </button>
        `;

        container.appendChild(wrapper);
    }

    function removeRelatedBlog(btn) {
        btn.closest(".input-group").remove();
    }
</script>

<script>
    const publishBtn = document.getElementById("publishBtn");

    document.getElementById("imageFile")
        .addEventListener("change", async function () {

            const file = this.files[0];
            if (!file) return;

            // ‚ùå Size validation
            if (file.size > MAX_IMAGE_SIZE) {
                alert("Image size must be under 400 KB");
                this.value = "";
                return;
            }

            // üîí lock submit
            uploadInProgress = true;
            publishBtn.disabled = true;

            const preview = document.getElementById("imagePreview");
            preview.src = URL.createObjectURL(file);
            preview.style.display = "block";

            const csrfToken =
                document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader =
                document.querySelector('meta[name="_csrf_header"]').content;

            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch("/admin/images/upload", {
                    method: "POST",
                    headers: { [csrfHeader]: csrfToken },
                    body: formData
                });

                if (!res.ok) throw new Error("Upload failed");

                const data = await res.json();
                document.getElementById("imageUrl").value = data.url;

            } catch (e) {
                alert("Image upload failed");
            } finally {
                // üîì unlock submit
                uploadInProgress = false;
                publishBtn.disabled = false;
            }
        });
</script>

<script>
    const removeBtn = document.getElementById("removeImageBtn");
    const previewImg = document.getElementById("imagePreview");
    const imageInput = document.getElementById("imageFile");
    const imageUrlInput = document.getElementById("imageUrl");

    // show remove button when image is uploaded
    document.getElementById("imageFile")
        .addEventListener("change", () => {
            removeBtn.style.display = "inline-block";
        });

    removeBtn.addEventListener("click", () => {
        // clear everything
        imageInput.value = "";
        imageUrlInput.value = "";
        previewImg.src = "";
        previewImg.style.display = "none";
        removeBtn.style.display = "none";
    });
</script>

<script>

    function addImageSection(imageUrl = '', heading = '', description = '') {

        const container = document.getElementById("imageSectionContainer");
        const index =
    document.querySelectorAll("#imageSectionContainer .card").length;

        const wrapper = document.createElement("div");
        wrapper.className = "card p-3";

        wrapper.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Section ${index + 1}</strong>
                <button type="button"
                        class="btn btn-sm btn-danger"
                        onclick="this.closest('.card').remove()">‚úï</button>
            </div>

            <input type="file"
                   class="form-control mb-2 section-image-file"
                   accept="image/*">

            <img class="section-image-preview mb-2"
                 style="display:${imageUrl ? 'block' : 'none'}; max-height:150px; border-radius:6px;"
                 src="${imageUrl}"/>

            <input type="hidden"
                   class="section-image-url"
                   data-field="imageUrl"
                   value="${imageUrl}">

            <button type="button"
                    class="btn btn-sm btn-outline-danger mb-2 remove-section-image"
                    style="display:${imageUrl ? 'inline-block' : 'none'};">
                Remove image
            </button>

            <input class="form-control mb-2"
                   placeholder="Section heading"
                   data-field="heading"
                   value="${heading}">

            <textarea class="form-control"
                      rows="3"
                      placeholder="Section description"
                      data-field="description">${description}</textarea>
        `;

        container.appendChild(wrapper);

        wireSectionImageUpload(wrapper);
    }
</script>

<script>
    function wireSectionImageUpload(card) {

        const fileInput = card.querySelector(".section-image-file");
        const preview = card.querySelector(".section-image-preview");
        const imageUrlInput = card.querySelector(".section-image-url");
        const removeBtn = card.querySelector(".remove-section-image");

        fileInput.addEventListener("change", async function () {

            const file = this.files[0];
            if (!file) return;

            // ‚ùå Size validation
            if (file.size > MAX_IMAGE_SIZE) {
                alert("Section image must be under 400 KB");
                this.value = "";
                return;
            }

            // üîí Lock publish button
            uploadInProgress = true;
            publishBtn.disabled = true;

            const csrfToken =
                document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader =
                document.querySelector('meta[name="_csrf_header"]').content;

            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch("/admin/images/upload", {
                    method: "POST",
                    headers: { [csrfHeader]: csrfToken },
                    body: formData
                });

                if (!res.ok) {
                    throw new Error("Upload failed");
                }

                const data = await res.json();

                // ‚úÖ Always use backend URL directly
                imageUrlInput.value = data.url;
                preview.src = data.url;

                preview.style.display = "block";
                removeBtn.style.display = "inline-block";

            } catch (e) {
                alert("Section image upload failed");
                fileInput.value = "";
            } finally {
                // üîì Unlock publish button
                uploadInProgress = false;
                publishBtn.disabled = false;
            }
        });

        removeBtn.addEventListener("click", () => {
            fileInput.value = "";
            imageUrlInput.value = "";
            preview.src = "";
            preview.style.display = "none";
            removeBtn.style.display = "none";
        });
    }
</script>

<!-- ================= FOOTER ================= -->
<footer th:replace="~{fragments/footer :: footer}"></footer>




</body>
</html>