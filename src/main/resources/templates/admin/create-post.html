<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Create Blog Post</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap"
          rel="stylesheet">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- Quill -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body class="bg-light">

<header th:replace="~{fragments/header :: header}"></header>

<div class="d-flex">

    <aside class="flex-shrink-0"
           sec:authorize="hasAnyRole('ADMIN','AUTHOR')">
        <div th:replace="~{fragments/admin-sidebar :: adminSidebar}"></div>
    </aside>

    <main class="flex-grow-1 p-4">

        <div class="mx-auto" style="max-width:760px;">

            <h3 class="fw-bold mb-4">Create Blog Post</h3>

            <form method="post"
                  th:action="@{/admin/posts/create}"
                  id="postForm">

                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}"/>

                <!-- TITLE -->
                <input class="form-control mb-3"
                       name="title"
                       placeholder="Post title"
                       required>

                <!-- LANGUAGE -->
                <select class="form-select mb-3" name="language" required>
                    <option value="">Select Language</option>
                    <option value="EN">English</option>
                    <option value="KN">Kannada</option>
                </select>

                <!-- CATEGORY -->
                <select class="form-select mb-3"
                        name="category"
                        id="categorySelect"
                        required>
                    <option value="">Select Category</option>
                    <option th:each="cat : ${categories}"
                            th:value="${cat}"
                            th:text="${cat}">
                    </option>
                </select>

                <!-- âœ… AI MODE (ONLY FOR AI CATEGORY) -->
                <div id="aiModeBox" class="mb-4" style="display:none;">
                    <label class="form-label fw-semibold">AI Post Type</label>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="radio"
                               name="aiPostMode"
                               value="BLOG"
                               checked>
                        <label class="form-check-label">
                            AI Blog / App / News
                        </label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="radio"
                               name="aiPostMode"
                               value="PROMPT">
                        <label class="form-check-label">
                            AI Prompt
                        </label>
                    </div>
                </div>

                <!-- IMAGE -->
                <input class="form-control mb-4"
                       name="imageUrl"
                       placeholder="Main image URL (optional)">

                <!-- INTRO -->
                <textarea class="form-control mb-4"
                          name="intro"
                          rows="4"
                          placeholder="Short intro paragraph"></textarea>

                <!-- CONTENT -->
                <h6 class="fw-bold mb-2">Post Content</h6>
                <div id="editor"
                     class="bg-white mb-3 border"
                     style="height:300px;"></div>

                <input type="hidden" name="sectionContent" id="sectionContent">

                <!-- âœ… AI PROMPT TABLE -->
                <div id="promptBox" style="display:none;">
                    <h6 class="fw-bold mt-4">AI Prompts</h6>

                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th style="width:200px">Prompt Name</th>
                            <th>Prompt Text</th>
                            <th style="width:60px"></th>
                        </tr>
                        </thead>
                        <tbody id="promptTableBody"></tbody>
                    </table>

                    <button type="button"
                            class="btn btn-outline-dark btn-sm"
                            onclick="addPromptRow()">
                        âž• Add Prompt
                    </button>
                </div>

                <!-- BULLETS -->
                <input class="form-control mb-2"
                       name="bulletTitle"
                       placeholder="Bullet section heading (optional)">

                <textarea class="form-control mb-4"
                          name="bullets"
                          rows="4"
                          placeholder="One bullet per line"></textarea>

                <!-- TIP -->
                <input class="form-control mb-2"
                       name="tipTitle"
                       placeholder="Tip title (optional)">

                <textarea class="form-control mb-4"
                          name="tipContent"
                          rows="3"
                          placeholder="Tip explanation"></textarea>

                <!-- PUBLISH -->
                <input type="hidden" name="publish" value="false">

                <div class="form-check mb-4">
                    <input class="form-check-input"
                           type="checkbox"
                           id="publish"
                           name="publish"
                           value="true"
                           checked>
                    <label class="form-check-label" for="publish">
                        Publish immediately
                    </label>
                </div>

                <button type="submit" class="btn btn-dark px-4">
                    Publish
                </button>

            </form>
        </div>

    </main>
</div>

<!-- QUILL -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Write your blog content here...',
        modules: {
            toolbar: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link'],
                ['clean']
            ]
        }
    });

    document.getElementById('postForm').addEventListener('submit', function (e) {
        const html = quill.root.innerHTML.trim();

        if (!html || html === '<p><br></p>') {
            alert('Post content cannot be empty');
            e.preventDefault();
            return;
        }
        document.getElementById('sectionContent').value = html;
    });

    /* =========================
       ðŸ”¥ AI PROMPT LOGIC (SAFE)
    ========================= */
    const categorySelect = document.getElementById('categorySelect');
    const aiModeBox = document.getElementById('aiModeBox');
    const promptBox = document.getElementById('promptBox');

    function handleCategoryChange() {
        if (categorySelect.value === 'AI') {
            aiModeBox.style.display = 'block';
        } else {
            aiModeBox.style.display = 'none';
            promptBox.style.display = 'none';
        }
    }

    categorySelect.addEventListener('change', handleCategoryChange);
    handleCategoryChange();

    document.querySelectorAll('[name="aiPostMode"]').forEach(radio => {
        radio.addEventListener('change', () => {
            promptBox.style.display =
                radio.value === 'PROMPT' && radio.checked
                    ? 'block'
                    : 'none';
        });
    });

function addPromptRow() {
    const tbody = document.getElementById('promptTableBody');

    const tr = document.createElement('tr');

    // Prompt Name
    const nameTd = document.createElement('td');
    const nameInput = document.createElement('input');
    nameInput.className = 'form-control';
    nameInput.name = 'promptNames';
    nameInput.placeholder = 'Prompt name';
    nameInput.required = true;
    nameTd.appendChild(nameInput);

    // Prompt Text
    const textTd = document.createElement('td');
    const textarea = document.createElement('textarea');
    textarea.className = 'form-control ai-prompt-textarea';
    textarea.name = 'promptTexts';
    textarea.rows = 4;
    textarea.placeholder = 'Enter AI prompt (max 1000 characters)';
    textarea.maxLength = 1000;
    textarea.spellcheck = false;
    textarea.wrap = 'soft';
    textTd.appendChild(textarea);

    // Remove Button
    const actionTd = document.createElement('td');
    actionTd.className = 'text-center';
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-sm btn-danger';
    btn.innerText = 'âœ•';
    btn.onclick = () => tr.remove();
    actionTd.appendChild(btn);

    tr.appendChild(nameTd);
    tr.appendChild(textTd);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
}

        function handlePromptKeydown(e, textarea) {
        const max = parseInt(textarea.dataset.maxChars || '1000');
        const allowedKeys = [
            'Backspace', 'Delete',
            'ArrowLeft', 'ArrowRight',
            'ArrowUp', 'ArrowDown',
            'Control', 'Meta'
        ];

        if (allowedKeys.includes(e.key) || e.ctrlKey || e.metaKey) {
            return;
        }

        if (textarea.value.length >= max) {
            e.preventDefault();
        }
    }

    function updateCharCount(textarea) {
        const counter =
            textarea.parentElement.querySelector('.char-count');

        if (counter) {
            counter.innerText = textarea.value.length;
        }

        // auto-grow height
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    // Init counters if rows already exist
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.ai-prompt-textarea')
            .forEach(t => updateCharCount(t));
    });
</script>

</body>
</html>